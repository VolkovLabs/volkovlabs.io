---
authors: [alex]
slug: form-panel-server-based-elements-20240428/
tags: [Data Manipulation, Server-based Elements]
image: /img/blog/2024-03-10-file-upload/banner.png
keywords: [Data Manipulation, Form Panel, Data, Grafana, Server-based Elements]
---

import Image from "@theme/Image";
import Video from "@theme/Video";

# Server-based control of Form elements in Data Manipulation panel

The Data Manipulation panel supports a showing elements dynamically.
But sometimes it's more convenient to build elements on the server side especially if there are a lot of elements.
Also it can be used for permissions control when different sets of elements are shown for users with different roles. (this is not covered within the blog post. Let us know if it's interesting use-case and we will describe it)

### Server

Create a Node.js HTTP server to build form elements. Server accepts `GET /form` request with a query parameter `device` and returns a appropriated form elements for the device
The full URL is `GET /form?device=device1`

Server code
```
const http = require('http');

/**
 * Server Port
 */
const port = 3001;

/**
 * Create Server
 */
const server = http.createServer(function (req: any, res: any) {
  /**
   * Set CORS headers
   */
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Request-Method', '*');
  res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT, PATCH');
  res.setHeader('Access-Control-Allow-Headers', '*');
  if (req.method === 'OPTIONS') {
    res.writeHead(200);
    res.end();

    return;
  }

  /**
   * Ping for json data source
   */
  if (req.url === '/') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.write(
      JSON.stringify({
        message: 'pong',
      })
    );
    res.end();
    return;
  }

  /**
   * Get form
   */
  const urlObject = new URL(`http://localhost${req.url}`);
  if (urlObject.pathname === '/form') {
    const device = urlObject.searchParams.get('device') || '';
    const formElements: unknown[] = [
      {
        uid: 'device',
        id: 'device',
        title: 'Device',
        type: 'select',
        value: device,
        options: [
          {
            id: 'device1',
            label: 'device1',
            type: 'string',
            value: 'device1',
          },
          {
            id: 'device2',
            label: 'device2',
            type: 'string',
            value: 'device2',
          },
        ],
        optionsSource: 'Custom',
      },
    ];

    /**
     * Add device1 elements
     */
    if (device === 'device1') {
      formElements.push({
        uid: 'device1Field',
        id: 'device1Field',
        title: 'Device 1 Field',
        type: 'number',
        value: 0,
        min: 0,
        max: 10,
      });
    }

    /**
     * Add device2 elements
     */
    if (device === 'device2') {
      formElements.push({
        uid: 'device2Field',
        id: 'device2Field',
        title: 'Device 2 Field',
        type: 'number',
        value: 0,
        min: 0,
        max: 10,
      });
    }

    /**
     * Add common elements
     */
    formElements.push({
      uid: 'comment',
      id: 'comment',
      title: 'Comment',
      type: 'textarea',
      value: '',
    });

    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.write(JSON.stringify(formElements));
    res.end();
    return;
  }
});

/**
 * Listen on port 3001
 */
server.listen(port);
console.log(`Server is running on port ${port}...`);
```

All possible form element options are described in Typescript Interface - [Form Element Type](https://github.com/VolkovLabs/volkovlabs-form-panel/blob/7fe03eb8787af65cdf42548c09db9d044bd6067e/src/types/form-element.ts#L427)

## Data Source

[JSON API Data source](https://grafana.com/grafana/plugins/marcusolsson-json-datasource/) is used for communication with the server.
<Image
  title="Configured JSON API Data source."
  src="/img/blog/2024-04-28-form-panel-server-based-elements/configured-json-datasource.png"
/>

## Dashboard Variables
Let's create device variable to filter our form elements based on it.
<Image
  title="Configured Device variable."
  src="/img/blog/2024-04-28-form-panel-server-based-elements/device-variable.png"
/>

Since now, everything is ready to setup the panel.

## Data Manipulation options

### Panel Data

Before configuring the initial request in the panel options, we have to setup a panel query with the configured data source above.
<Image
  title="Configured GET request with device variable value."
  src="/img/blog/2024-04-28-form-panel-server-based-elements/panel-query-path.png"
/>

After that, the fields should be specified to map a response json to panel data
<Image
  title="Configured fields to take response json into panel data."
  src="/img/blog/2024-04-28-form-panel-server-based-elements/panel-query-fields.png"
/>

### Initial request
Since the panel data has a form element json we can configure an initial request.
<Image
  title="Configured query initial request"
  src="/img/blog/2024-04-28-form-panel-server-based-elements/initial-request.png"
/>

To set form elements from the panel data the following custom code should be used. Also some adjusting with helpers object is needed to make it working correctly.

Custom code
```
/**
 * Convert JSON to form elements array
 */
const formElements = JSON.parse(context.panel.data.series[0].fields[0].values[0])

/**
 * Set elements with helpers
 */
context.panel.onChangeElements(formElements.map((element) => ({
  ...element,
  helpers: {
    showIf: () => true,
    disableIf: () => false,
    getOptions: () => element.options,
  }
})),
);
```

After that, for different device value the appropriated form elements will be loaded and shown within the panel
<Image
  title="Device 1 Form elements"
  src="/img/blog/2024-04-28-form-panel-server-based-elements/device1-form-elements.png"
/>
<Image
  title="Device 2 Form elements"
  src="/img/blog/2024-04-28-form-panel-server-based-elements/device2-form-elements.png"
/>

### Update variable from the form
Now, if user changes the device field, the new form elements won't be loaded. Let's fix it and add a device variable update on the device form element change with Element Value Changed code
```
/**
 * Update device variable
 */
if (context.element.id === 'device') {
  context.grafana.locationService.partial({
    'var-device': context.element.value,
  })
}
```

### Keeping comment value on the device change
Now if user changes the device field, all fields are cleaned. Sometimes it's needed to keep entered values for the common fields.
Let's adjust the custom code in the initial request section to keep a comment field value on the device variable change
```
/**
 * Convert JSON to form elements array
 */
const formElements = JSON.parse(context.panel.data.series[0].fields[0].values[0])

/**
 * Set elements with helpers
 */
context.panel.onChangeElements(formElements.map((element) => {
  const elementInForm = context.panel.elements.find((item) => item.uid === element.uid);
  let value = element.value;

  if (element.uid === 'comment' && elementInForm) {
    value = elementInForm.value;
  }

  return {
    ...element,
    value,
    helpers: {
      showIf: () => true,
      disableIf: () => false,
      getOptions: () => element.options,
    }
  }
}),
);
```


### Outcomes

The panel has appropriated form elements based on the selected device.

## Afterword

If you have any questions about this article, please, do not hesitate to leave them in the comments section under the [YouTube videos](https://www.youtube.com/@volkovlabs).
