---
authors: [mikhail]
slug: nginx-loki-grafana-20230129
tags: [Weekend Project, Loki, NGINX]
image: /img/blog/2023-01-29-nginx-loki-grafana/banner.png
keywords: [NGINX, Loki, Grafana, Analytics]
---

import Image from "@theme/Image";
import Video from "@theme/Video";

# Website Analytics based on Nginx, Loki, Promtail, and Grafana.

We use Google Analytics to track activities on our web-site with blog and documentation. Everytime when I open it, I want to close it. Why? Interface is too cluttered with compaigns, revenue, retention, channels, etc. Real-time capabilities allows to see only last 30 minutes. You can spend extra time configuring custom dashboards and reports, but still I got a feeling that we are missing user activities.

One of the reasons to miss activities, Google Analytics request may get blocked on firewalls, security devices, VPN and requests won't be reported to the servers.

<!--truncate-->

This is how the weekend project started to configured Nginx, Loki, Promtail and Grafana to work together and show the big picture. In this project we are interested in Business metrics rather than Technical on how many log files were parsed, size, etc.

<Image
  title="Website Analytics based on NGINX, Loki and Grafana."
  src="/img/blog/2023-01-29-nginx-loki-grafana/dashboard.png"
/>

You may google around and found various dashboards, outdated GitHub repositories, and other pieces of information covering some steps. I was not able to find straightforward and up-to-date resource which describes what I wanted to accomplished.

Let's take a closer look at each component one-by-one.

## Nginx

Nginx is a web server that can also be used as a reverse proxy, load balancer, HTTP server, etc. We use it in front of all our projects, running in Docker, and it's installed on the host for optimal performance.

When you configure format of the log files, you can collect everything and then decided what do you need or may need in future. Or choose what you really need and keep it short. For this project we selected:

| Variable             | Description                                              |
| -------------------- | -------------------------------------------------------- |
| `time_local`         | Local time.                                              |
| `remote_addr`        | Client IP.                                               |
| `request_uri`        | Full path and arguments for the request.                 |
| `status`             | Response status code.                                    |
| `http_referer`       | HTTP referer.                                            |
| `http_user_agent`    | HTTP client (user agent).                                |
| `server_name`        | The name of the server handling the request.             |
| `request_time`       | Request processing time in seconds with msec resolution. |
| `geoip_country_code` | Geo location based on client IP.                         |

The additional configuration which we added to the main configuration file `nginx.conf`:

- Replace empty values in `http_referer` as `(direct)` similar to Google Analytics.
- Replace empty values in `http_user_agent` as `Unknown`.
- Replace empty values in `geoip_country_code` as `Unknown`, which we display with the pirate flag on our dashboard.
- Use preinstalled GeoIP database `/usr/share/GeoIP/GeoIP.dat`.
- Add `json_analytics` logging JSON format, which we will use for server blocks.

```nginx title=nginx.conf
http {
  map $http_referer $httpReferer {
    default "$http_referer";
    ""      "(direct)";
  }

  map $http_user_agent $httpAgent {
    default "$http_user_agent";
    ""      "Unknown";
  }

  map $geoip_country_code $geoIP {
    default "$geoip_country_code";
    ""      "Unknown";
  }

  geoip_country /usr/share/GeoIP/GeoIP.dat;

  log_format json_analytics escape=json '{'
    '"time_local": "$time_local", '
    '"remote_addr": "$remote_addr", '
    '"request_uri": "$request_uri", '
    '"status": "$status", '
    '"http_referer": "$httpReferer", '
    '"http_user_agent": "$httpAgent", '
    '"server_name": "$server_name", '
    '"request_time": "$request_time", '
    '"geoip_country_code": "$geoIP"'
    '}';
}
```

A JSON record from the log file looks like this

```json title=analytics.log
{
  "time_local": "29/Jan/2023:02:57:08 +0000",
  "remote_addr": "111.222.334.444",
  "request_uri": "/plugins/volkovlabs-form-panel/request/",
  "status": "200",
  "http_referer": "(direct)",
  "http_user_agent": "Mozilla/5.0",
  "server_name": "volkovlabs.io",
  "request_time": "0.000",
  "geoip_country_code": "CZ"
}
```

### GeoIP

Preinstalled GeoIP database on our Linux server is out-dated, but works great for this project and does not required additional configuration. To use it Nginx should have [`ngx_http_geoip_module` module](http://nginx.org/en/docs/http/ngx_http_geoip_module.html) enabled.

```sh
/usr/share/GeoIP# ls -lrt
total 7912
-rw-r--r-- 1 root root 6426573 Nov  8  2018 GeoIPv6.dat
-rw-r--r-- 1 root root 1672893 Nov  8  2018 GeoIP.dat
```

[GeoIP2 database](https://www.maxmind.com/en/geoip2-databases) can be used instead. It requires:

- Setup an account.
- Additional configuration for daily updates.
- Compile Nginx with additional module on our version of LinuxOS.

You can find instructions on how to do it and go this route if required.

### Server

When using the Nginx web server, server blocks can be used to encapsulate configuration details and host more than one domain on a single server. In the configuration file for `volkovlabs.io` we added additional logging file `analytics.log` using defined JSON format:

```nginx title="Virtual Server"
server {
  access_log /var/log/nginx/analytics.log json_analytics;
}
```

## Loki

Loki is a horizontally scalable, highly available, multi-tenant log aggregation system inspired by Prometheus. It is designed to be very cost effective and easy to operate. It does not index the contents of the logs, but rather a set of labels for each log stream.

We are running Loki in Docker container started using `docker-compose`.

- The data folder `/loki` stored in the volume folder on local drive.
- Configuration file `/etc/loki/local-config.yaml` stored in the `loki` folder next to the data.
- We use the latest stable version `2.7.1`.

```docker title=docker-compose.yml
  loki:
    container_name: loki
    image: grafana/loki:2.7.1
    network_mode: host
    volumes:
      - ./loki/data:/loki
      - ./loki/loki.yml:/etc/loki/local-config.yaml
```

Loki, Promtail and Grafana containers are located on separete hosts and we run them in the network host mode, which is out of scope for this article.

### Configuration

Configuration file is based on the default file shipped with `2.7.1` release with additional configuration to increase number of maximum outstanding requests to accomodate the Grafana dashboard.

```yaml title=./loki/loki.yml
auth_enabled: false

server:
  http_listen_port: 3100

common:
  path_prefix: /loki
  storage:
    filesystem:
      chunks_directory: /loki/chunks
      rules_directory: /loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

ruler:
  alertmanager_url: http://localhost:9093

query_scheduler:
  max_outstanding_requests_per_tenant: 10000
```

You can learn more about Loki configuration in the [Documentation](https://grafana.com/docs/loki/latest/configuration/).

## Promtail

Promtail is an agent which ships the contents of local logs to a private Grafana Loki instance. It is usually deployed to every machine that has applications needed to be monitored.

Similar to Loki we are running Promtail in Docker container started with `docker-compose`.

- Configuration file `/etc/promtail/config.yml` stored in the `loki` folder.
- The Nginx log folder `/var/log/nginx` added to the container.
- We use the latest stable version `2.7.1`.

```docker title=docker-compose.yml
  promtail:
    image: grafana/promtail:2.7.1
    container_name: promtail
    network_mode: host
    volumes:
      - ./loki/promtail.yml:/etc/promtail/config.yml
      - /var/log/nginx:/var/log/nginx
```

### Configuration

Configuration file is based on the default file shipped with `2.7.1` release with

- Additional configuration for Nginx analytics log files to add labels `job`, `host`, `agent` and watch only `analytics.log` files.
- Pipeline stages to drop records we are not interested in:
  - Requests from Googlebot, inspectors, test, network devices and RSS collectors.
  - Requests for images and assets (Javascript, CSS) in the special folders.
  - Requests for special files for browsers and indexing engines.
  - Malicious request to find PHP and XML files.

Promtail push logs to the Loki specified in the configuration file `http://LOKI-IP:3100/loki/api/v1/push`.

```yaml title=./loki/promtail.yml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://LOKI-IP:3100/loki/api/v1/push

scrape_configs:
  - job_name: nginx
    static_configs:
      - targets:
          - localhost
        labels:
          job: nginx
          host: volkovlabs.io
          agent: promtail
          __path__: /var/log/nginx/analytics*log
    pipeline_stages:
      - json:
          expressions:
            http_user_agent:
            request_uri:
      - drop:
          source: http_user_agent
          expression: "(bot|Bot|RSS|Inspect|test)"
      - drop:
          source: request_uri
          expression: "/(assets|img)/"
      - drop:
          source: request_uri
          expression: "/(robots.txt|favicon.ico)"
      - drop:
          source: request_uri
          expression: "(.php|.xml)$"
```

The [Pipelines](https://grafana.com/docs/loki/latest/clients/promtail/pipelines/) can be changed and updated based on your requirements.

## Grafana

We love Grafana and use it for all our projects. We have it already installed on our servers and Daria covered the process in the video.

<Video
  src="https://www.youtube.com/embed/xTQpV7B700w"
  title="How to Install Grafana for Data Analysts and Data Scientists."
/>

In another video, Daria explained how to create your first Grafana dashboard with detailed step-by-step instructions for many Grafana panels, including Geomap used for this project.

<Video
  src="https://www.youtube.com/embed/HNCKbGfAU0Q"
  title="How to create your Business Grafana dashboard."
/>

### Loki data source

Loki data source is preinstalled in Grafana. We used default configuration with URL `http://localhost:3100`.

Grafana and Loki are deployed on the same host in Docker containers configured in network host mode.

<Image
  title="Loki data source configuration in Grafana."
  src="/img/blog/2023-01-29-nginx-loki-grafana/loki.png"
/>

### Dashboard

Website Analytics dashboard was inspired by [Grafana Loki Dashboard for NGINX Service Mesh](https://grafana.com/grafana/dashboards/12559-grafana-loki-dashboard-for-nginx-service-mesh/?pg=dashboards&plcmt=featured-main), one of the most interesting and updated dashboard we can find.

Each panel and query was updated according to our styling guidelines and business requirements.

<Image
  title="Table panel with values mapping for 50+ countries to display Geo locations."
  src="/img/blog/2023-01-29-nginx-loki-grafana/table.png"
/>

### Import

To import the dashboard, find the `Import` menu. The location might differ depending on your installed Grafana version, but that menu should always be somewhere.

<Image
  title="Import dashboard file into Grafana."
  src="/img/blog/2023-01-29-nginx-loki-grafana/import-menu.png"
/>

For the dashboard to function correctly, you must have the Loki data source installed and configured.

<details>
  <summary>Grafana dashboard source code</summary>

```json
{
  "__inputs": [
    {
      "name": "DS_LOKI",
      "label": "Loki",
      "description": "",
      "type": "datasource",
      "pluginId": "loki",
      "pluginName": "Loki"
    }
  ],
  "__elements": {},
  "__requires": [
    {
      "type": "panel",
      "id": "geomap",
      "name": "Geomap",
      "version": ""
    },
    {
      "type": "grafana",
      "id": "grafana",
      "name": "Grafana",
      "version": "9.3.6"
    },
    {
      "type": "panel",
      "id": "logs",
      "name": "Logs",
      "version": ""
    },
    {
      "type": "datasource",
      "id": "loki",
      "name": "Loki",
      "version": "1.0.0"
    },
    {
      "type": "panel",
      "id": "stat",
      "name": "Stat",
      "version": ""
    },
    {
      "type": "panel",
      "id": "table",
      "name": "Table",
      "version": ""
    },
    {
      "type": "panel",
      "id": "timeseries",
      "name": "Time series",
      "version": ""
    }
  ],
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "datasource",
          "uid": "grafana"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "target": {
          "limit": 100,
          "matchAny": false,
          "tags": [],
          "type": "dashboard"
        },
        "type": "dashboard"
      }
    ]
  },
  "description": "NGINX Analytics",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "gnetId": 12559,
  "graphTooltip": 2,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "text",
                "value": null
              },
              {
                "color": "#9d70f9",
                "value": 5
              },
              {
                "color": "#eb4444",
                "value": 10
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 17,
        "w": 17,
        "x": 0,
        "y": 0
      },
      "id": 14,
      "interval": "5m",
      "options": {
        "basemap": {
          "config": {
            "server": "streets"
          },
          "name": "Layer 0",
          "opacity": 1,
          "tooltip": true,
          "type": "esri-xyz"
        },
        "controls": {
          "mouseWheelZoom": false,
          "showAttribution": false,
          "showDebug": false,
          "showMeasure": false,
          "showScale": false,
          "showZoom": false
        },
        "layers": [
          {
            "config": {
              "color": {
                "fixed": "semi-dark-blue"
              },
              "fillOpacity": 0.3,
              "shape": "circle",
              "showLegend": false,
              "size": {
                "field": "Value",
                "fixed": 5,
                "max": 50,
                "min": 10
              },
              "style": {
                "color": {
                  "field": "Value (sum)",
                  "fixed": "dark-green"
                },
                "opacity": 1,
                "rotation": {
                  "fixed": 0,
                  "max": 360,
                  "min": -360,
                  "mode": "mod"
                },
                "size": {
                  "field": "Value (sum)",
                  "fixed": 5,
                  "max": 15,
                  "min": 2
                },
                "symbol": {
                  "fixed": "img/icons/marker/circle.svg",
                  "mode": "fixed"
                },
                "text": {
                  "field": "Metric",
                  "fixed": "",
                  "mode": "fixed"
                }
              }
            },
            "location": {
              "lookup": "Metric",
              "mode": "lookup"
            },
            "name": "Requests",
            "tooltip": true,
            "type": "markers"
          }
        ],
        "tooltip": {
          "mode": "details"
        },
        "view": {
          "allLayers": true,
          "id": "zero",
          "lat": 0,
          "lon": 0,
          "shared": false,
          "zoom": 2
        }
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by(geoip_country_code) (count_over_time({host=~\"$host\"} | json | geoip_country_code != `` [$__interval]))",
          "instant": false,
          "legendFormat": "{{geoip_country_code}}",
          "queryType": "range",
          "range": true,
          "refId": "A"
        }
      ],
      "transformations": [
        {
          "id": "seriesToRows",
          "options": {}
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "Metric": {
                "aggregations": [],
                "operation": "groupby"
              },
              "Value": {
                "aggregations": ["sum"],
                "operation": "aggregate"
              }
            }
          }
        }
      ],
      "type": "geomap"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "#9d70f9",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 4,
        "x": 17,
        "y": 0
      },
      "hideTimeOverride": false,
      "id": 4,
      "interval": "5m",
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "center",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["sum"],
          "fields": "",
          "values": false
        },
        "text": {},
        "textMode": "value"
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by(host) (count_over_time({host=~\"$host\"}[$__interval]))  ",
          "legendFormat": "{{host}}",
          "queryType": "range",
          "refId": "A"
        }
      ],
      "title": "Requests  ",
      "transformations": [],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "Different IP addresses",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "#9d70f9",
                "value": null
              }
            ]
          }
        },
        "overrides": []
      },
      "gridPos": {
        "h": 3,
        "w": 3,
        "x": 21,
        "y": 0
      },
      "id": 22,
      "interval": "1h",
      "options": {
        "colorMode": "background",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "text": {},
        "textMode": "value"
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "count(sum by (remote_addr) (count_over_time({host=~\"$host\"} | json [$__interval])))",
          "instant": true,
          "legendFormat": "",
          "queryType": "range",
          "range": false,
          "refId": "A"
        }
      ],
      "title": "Visitors per Hour",
      "transformations": [],
      "type": "stat"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "mappings": [
            {
              "options": {
                "AD": {
                  "index": 1,
                  "text": "üá¶üá© Andorra"
                },
                "AE": {
                  "index": 2,
                  "text": "üá¶üá™ United Arab Emirates"
                },
                "AF": {
                  "index": 3,
                  "text": "üá¶üá´ Afghanistan"
                },
                "AR": {
                  "index": 4,
                  "text": "üá¶üá∑ Argentina"
                },
                "AT": {
                  "index": 5,
                  "text": "üá¶üáπ Austria"
                },
                "AU": {
                  "index": 6,
                  "text": "üá¶üá∫ Australia"
                },
                "BE": {
                  "index": 7,
                  "text": "üáßüá™ Belgium"
                },
                "BR": {
                  "index": 8,
                  "text": "üáßüá∑ Brazil"
                },
                "BT": {
                  "index": 9,
                  "text": "üáßüáπ Bhutan"
                },
                "CA": {
                  "index": 10,
                  "text": "üá®üá¶ Canada"
                },
                "CH": {
                  "index": 11,
                  "text": "üá®üá≠ Switzerland"
                },
                "CN": {
                  "index": 12,
                  "text": "üá®üá≥ China"
                },
                "CZ": {
                  "index": 13,
                  "text": "üá®üáø Czech Republic"
                },
                "DE": {
                  "index": 14,
                  "text": "üá©üá™ Germany"
                },
                "ES": {
                  "index": 15,
                  "text": "üá™üá∏ Spain"
                },
                "FR": {
                  "index": 16,
                  "text": "üá´üá∑ France"
                },
                "GB": {
                  "index": 17,
                  "text": "üá¨üáß United Kingdom"
                },
                "GR": {
                  "index": 18,
                  "text": "üá¨üá∑ Greece"
                },
                "HN": {
                  "index": 20,
                  "text": "üá≠üá≥ Honduras"
                },
                "HR": {
                  "index": 21,
                  "text": "üá≠üá∑ Croatia"
                },
                "HU": {
                  "index": 19,
                  "text": "üá≠üá∫ Hungary"
                },
                "ID": {
                  "index": 22,
                  "text": "üáÆüá© Indonesia"
                },
                "IL": {
                  "index": 23,
                  "text": "üáÆüá± Israel"
                },
                "IN": {
                  "index": 24,
                  "text": "üáÆüá≥ India"
                },
                "IR": {
                  "index": 25,
                  "text": "üáÆüá∑ Iran"
                },
                "IT": {
                  "index": 26,
                  "text": "üáÆüáπ Italy"
                },
                "JO": {
                  "index": 27,
                  "text": "üáØüá¥ Jordan"
                },
                "JP": {
                  "index": 28,
                  "text": "üáØüáµ Japan"
                },
                "KZ": {
                  "index": 29,
                  "text": "üá∞üáø Kazakhstan"
                },
                "MD": {
                  "index": 30,
                  "text": "üá≤üá© Moldova"
                },
                "MX": {
                  "index": 31,
                  "text": "üá≤üáΩ Mexico"
                },
                "MY": {
                  "index": 32,
                  "text": "üá≤üáæ Malaysia"
                },
                "NL": {
                  "index": 33,
                  "text": "üá≥üá± Netherlands"
                },
                "NO": {
                  "index": 34,
                  "text": "üá≥üá¥ Norway"
                },
                "NZ": {
                  "index": 35,
                  "text": "üá≥üáø New Zealand"
                },
                "PL": {
                  "index": 36,
                  "text": "üáµüá± Poland"
                },
                "PT": {
                  "index": 37,
                  "text": "üáµüáπ Portugal"
                },
                "RU": {
                  "index": 38,
                  "text": "üá∑üá∫ Russia"
                },
                "SC": {
                  "index": 39,
                  "text": "üá∏üá® Seychelles"
                },
                "SE": {
                  "index": 45,
                  "text": "üá∏üá™ Sweden"
                },
                "SG": {
                  "index": 40,
                  "text": "üá∏üá¨ Singapore"
                },
                "TH": {
                  "index": 41,
                  "text": "üáπüá≠ Thailand"
                },
                "TR": {
                  "index": 42,
                  "text": "üáπüá∑ Turkey"
                },
                "UA": {
                  "index": 43,
                  "text": "üá∫üá¶ Ukraine"
                },
                "US": {
                  "index": 44,
                  "text": "üá∫üá∏ United States"
                },
                "Unknown": {
                  "index": 0,
                  "text": "üè¥‚Äç‚ò†Ô∏è Unknown"
                }
              },
              "type": "value"
            }
          ],
          "noValue": "Unknown",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value (sum)"
            },
            "properties": [
              {
                "id": "custom.displayMode",
                "value": "gradient-gauge"
              },
              {
                "id": "color",
                "value": {
                  "mode": "continuous-BlPu"
                }
              },
              {
                "id": "custom.width",
                "value": 200
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 14,
        "w": 7,
        "x": 17,
        "y": 3
      },
      "id": 3,
      "interval": "5m",
      "options": {
        "footer": {
          "fields": "",
          "reducer": ["sum"],
          "show": false
        },
        "showHeader": false,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Value (sum)"
          }
        ]
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by (geoip_country_code) (count_over_time({host=~\"$host\"} | json [$__interval]))",
          "instant": true,
          "legendFormat": "{{geoip_country_code}}",
          "queryType": "range",
          "range": false,
          "refId": "A"
        }
      ],
      "transformations": [
        {
          "id": "seriesToRows",
          "options": {}
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "Metric": {
                "aggregations": [],
                "operation": "groupby"
              },
              "Value": {
                "aggregations": ["sum"],
                "operation": "aggregate"
              }
            }
          }
        }
      ],
      "type": "table"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "mappings": [],
          "noValue": "None",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value (sum)"
            },
            "properties": [
              {
                "id": "custom.displayMode",
                "value": "gradient-gauge"
              },
              {
                "id": "color",
                "value": {
                  "mode": "continuous-BlPu"
                }
              },
              {
                "id": "custom.width",
                "value": 300
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 11,
        "x": 0,
        "y": 17
      },
      "id": 6,
      "interval": "5m",
      "options": {
        "footer": {
          "fields": "",
          "reducer": ["sum"],
          "show": false
        },
        "showHeader": false,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Value (sum)"
          }
        ]
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by (http_referer) (count_over_time({host=~\"$host\"} | json [$__interval]))",
          "instant": true,
          "legendFormat": "{{http_referer}}",
          "queryType": "range",
          "range": false,
          "refId": "A"
        }
      ],
      "title": "Referers",
      "transformations": [
        {
          "id": "seriesToRows",
          "options": {}
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "Metric": {
                "aggregations": [],
                "operation": "groupby"
              },
              "Value": {
                "aggregations": ["sum"],
                "operation": "aggregate"
              }
            }
          }
        }
      ],
      "type": "table"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value (sum)"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 300
              },
              {
                "id": "custom.displayMode",
                "value": "gradient-gauge"
              },
              {
                "id": "color",
                "value": {
                  "mode": "continuous-BlPu"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 13,
        "x": 11,
        "y": 17
      },
      "id": 24,
      "interval": "5m",
      "options": {
        "footer": {
          "fields": "",
          "reducer": ["sum"],
          "show": false
        },
        "showHeader": false,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Value (sum)"
          }
        ]
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by (request_uri) (count_over_time({host=~\"$host\"} | json | status = 200 [$__interval]))",
          "instant": true,
          "legendFormat": "{{request_uri}}",
          "queryType": "range",
          "range": false,
          "refId": "A"
        }
      ],
      "title": "Successfully Requested Pages",
      "transformations": [
        {
          "id": "seriesToRows",
          "options": {}
        },
        {
          "id": "groupBy",
          "options": {
            "fields": {
              "Metric": {
                "aggregations": [],
                "operation": "groupby"
              },
              "Value": {
                "aggregations": ["sum"],
                "operation": "aggregate"
              }
            }
          }
        }
      ],
      "type": "table"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 27
      },
      "id": 28,
      "panels": [],
      "title": "Requests",
      "type": "row"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "continuous-BlPu"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "bars",
            "fillOpacity": 100,
            "gradientMode": "hue",
            "hideFrom": {
              "graph": false,
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "#EAB839",
                "value": 0.2
              },
              {
                "color": "red",
                "value": 0.3
              }
            ]
          },
          "unit": "ms"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "max latency"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "super-light-blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 11,
        "x": 0,
        "y": 28
      },
      "id": 16,
      "interval": "5m",
      "options": {
        "legend": {
          "calcs": ["mean"],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "desc"
        }
      },
      "pluginVersion": "8.0.0-beta3",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "quantile_over_time(0.95,{host=~\"$host\"} | json | unwrap request_time [$__interval]) by (host)",
          "legendFormat": "95th Percentile",
          "queryType": "range",
          "refId": "C"
        },
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "max by (host) (max_over_time({host=~\"$host\"} | json | unwrap request_time  [$__interval]))",
          "legendFormat": "Max Latency",
          "queryType": "range",
          "refId": "D"
        }
      ],
      "title": "Processing Time",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "bars",
            "fillOpacity": 39,
            "gradientMode": "hue",
            "hideFrom": {
              "graph": false,
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "smooth",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": true,
            "stacking": {
              "group": "A",
              "mode": "normal"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "decimals": 0,
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          },
          "unit": "short"
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "HTTP Status 500"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "{statuscode=\"200\"} 200"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "green",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "{statuscode=\"404\"} 404"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "semi-dark-purple",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "{statuscode=\"500\"} 500"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "dark-red",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "HTTP Status 404"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "light-orange",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "HTTP Status 301"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "light-blue",
                  "mode": "fixed"
                }
              }
            ]
          },
          {
            "matcher": {
              "id": "byName",
              "options": "HTTP Status 200"
            },
            "properties": [
              {
                "id": "color",
                "value": {
                  "fixedColor": "semi-dark-blue",
                  "mode": "fixed"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 10,
        "w": 13,
        "x": 11,
        "y": 28
      },
      "id": 26,
      "interval": "5m",
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "pluginVersion": "8.0.0-beta3",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by (status) (count_over_time({host=~\"$host\"} | json [$__interval]))",
          "legendFormat": "HTTP Status {{status}}",
          "queryType": "range",
          "refId": "A"
        }
      ],
      "title": "Status",
      "transformations": [],
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "custom": {
            "align": "auto",
            "displayMode": "auto",
            "filterable": false,
            "inspect": false
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "red",
                "value": 80
              }
            ]
          }
        },
        "overrides": [
          {
            "matcher": {
              "id": "byName",
              "options": "Value"
            },
            "properties": [
              {
                "id": "custom.width",
                "value": 300
              },
              {
                "id": "custom.displayMode",
                "value": "gradient-gauge"
              },
              {
                "id": "color",
                "value": {
                  "mode": "continuous-BlPu"
                }
              }
            ]
          }
        ]
      },
      "gridPos": {
        "h": 11,
        "w": 11,
        "x": 0,
        "y": 38
      },
      "id": 7,
      "interval": "5m",
      "options": {
        "footer": {
          "fields": "",
          "reducer": ["sum"],
          "show": false
        },
        "frameIndex": 0,
        "showHeader": false,
        "sortBy": [
          {
            "desc": true,
            "displayName": "Value"
          }
        ]
      },
      "pluginVersion": "9.3.6",
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "sum by (http_user_agent) (count_over_time({host=~\"$host\"} | json [$__interval]))",
          "instant": true,
          "legendFormat": "{{http_user_agent}}",
          "queryType": "range",
          "range": false,
          "refId": "A"
        }
      ],
      "title": "User Agents",
      "transformations": [
        {
          "id": "seriesToRows",
          "options": {}
        },
        {
          "id": "filterFieldsByName",
          "options": {
            "include": {
              "names": ["Metric", "Value"]
            }
          }
        }
      ],
      "type": "table"
    },
    {
      "datasource": {
        "type": "loki",
        "uid": "${DS_LOKI}"
      },
      "description": "",
      "gridPos": {
        "h": 11,
        "w": 13,
        "x": 11,
        "y": 38
      },
      "id": 11,
      "interval": "5m",
      "maxDataPoints": 1,
      "options": {
        "dedupStrategy": "signature",
        "enableLogDetails": true,
        "prettifyLogMessage": false,
        "showCommonLabels": false,
        "showLabels": false,
        "showTime": false,
        "sortOrder": "Descending",
        "wrapLogMessage": true
      },
      "targets": [
        {
          "datasource": {
            "type": "loki",
            "uid": "${DS_LOKI}"
          },
          "editorMode": "code",
          "expr": "{host=~\"$host\"} | json | line_format \"{{.request_uri}} with HTTP status: {{.status}} \"",
          "legendFormat": "",
          "queryType": "range",
          "refId": "A"
        }
      ],
      "title": "Logs",
      "type": "logs"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 37,
  "style": "dark",
  "tags": [],
  "templating": {
    "list": [
      {
        "current": {},
        "datasource": {
          "type": "loki",
          "uid": "${DS_LOKI}"
        },
        "definition": "label_values($label_name)",
        "hide": 0,
        "includeAll": true,
        "label": "Host",
        "multi": true,
        "name": "host",
        "options": [],
        "query": {
          "label": "host",
          "refId": "LokiVariableQueryEditor-VariableQuery",
          "stream": "",
          "type": 1
        },
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "sort": 1,
        "tagValuesQuery": "",
        "tagsQuery": "",
        "type": "query",
        "useTags": false
      }
    ]
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {
    "refresh_intervals": [
      "10s",
      "30s",
      "1m",
      "5m",
      "15m",
      "30m",
      "1h",
      "2h",
      "1d"
    ]
  },
  "timezone": "",
  "title": "Website Analytics",
  "uid": "Nz6kKgtGj",
  "version": 217,
  "weekStart": ""
}
```

</details>

## Summary

The proposed solution beat our expectations, and we are looking forward to update Grafana dashboard based on the collected data.

Eliminating unnecessary data allows to laser focus on metrics we are looking for. The created dashboard is clean without unnecessary clutter. An excellent example of the pure elegance.
