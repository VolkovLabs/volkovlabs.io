---
authors:
  - name: Sineos
    image_url: https://github.com/Sineos.png
    title: Community member.
slug: stacked-bar-graph-20221004/
tags: [Apache ECharts, Community]
image: /img/blog/2022-10-04-stacked-bar-graph/banner.png
keywords: [Apache ECharts, Grafana, Visualization]
updated: 2023-01-31
---

import Image from "@theme/Image";

# Create Stacked Bars using the Apache ECharts visualization panel

[Sineos](https://github.com/Sineos) opened an [issue in the Apache ECharts repository](https://github.com/VolkovLabs/volkovlabs-echarts-panel/issues/47) asking for help with Stacked Bar Graph:

> "I have three queries returning aggregated monthly values, which I would like to display as a Stacked bar graph. Turning it into a simple bar graph works but dividing the data too differently styled bars just ends up with errors."

<!--truncate-->

The issue was successfully resolved, and Sineos created this example and attached

- Apache ECharts function,
- InfluxDB queries to retrieve data,
- Ready-to-go Dashboard using the Static Data Source.

<Image
  title="Energy balance visualized in Apache ECharts panel for Grafana."
  src="/img/blog/2022-10-04-stacked-bar-graph/panel.png"
/>

## InfluxDB Data Source

- `createEmpty: true` makes sure that the data of the individual bar segments stays aligned when data is missing in the series.
- `set(key: "Source", value: "Self Consumption")` manipulates the field used for naming the series.

### Query A

```sql
from(bucket: "home")
  |>  range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |>  filter(fn: (r)  => r["_measurement"] == "vzlogger")
  |>  filter(fn: (r)  => r["Source"] == "SML_Energy_Out")
  |>  filter(fn: (r)  => r["_field"] == "Energy")
  |>  aggregateWindow(every: 1d, fn: sum, createEmpty: true)
  |>  set(key: "Source",  value: "Grid Feed")
```

### Query B

```sql
from(bucket: "home")
  |>  range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |>  filter(fn: (r)  => r["_measurement"] == "vzlogger")
  |>  filter(fn: (r)  => r["Source"] == "SML_Energy_In")
  |>  filter(fn: (r)  => r["_field"] == "Energy")
  |>  aggregateWindow(every: 1d, fn: sum, createEmpty: true)
  |>  set(key: "Source",  value: "Grid Consumption")
```

### Query C

```sql
from(bucket: "home")
  |>  range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |>  filter(fn: (r)  => r["_measurement"] == "vzlogger")
  |>  filter(fn: (r)  => r["Source"] == "SelfConsumption")
  |>  filter(fn: (r)  => r["_field"] == "Energy")
  |>  aggregateWindow(every: 1d, fn: sum, createEmpty: true)
  |>  set(key: "Source",  value: "Self Consumption")
```

## Apache ECharts visualization panel function

```js
const series = data.series.map((s) => {
  let sData = s.fields.find((f) => f.type === "number").values.buffer;

  // Move 'Grid Feed' to the negative quadrant
  if (s.refId === "A") {
    sData = sData.map(function (x) {
      return x * -1.0;
    });
  }

  // It seems that ECharts is no friend of Unix timestamps
  // Use JS date and set the hours to 0 since we are interested
  // in the entire day
  let sTime = s.fields.find((f) => f.type === "time").values.buffer;
  sTime = sTime.map(function (x) {
    // Move back 1 ms to avoid the overflow to the next day
    x -= 1;
    const tmpDate = new Date(x);
    return tmpDate.setHours(0, 0, 0, 0);
  });

  return {
    name: s.fields[1].labels.Source,
    type: "bar",
    stack: "total",
    // 'createEmpty: true' is needed to align the bars in case of missing values
    // but creates 'null' values in the data and eCharts fails
    // Make sure to catch the null values via 'd ? d.toFixed(2) : 0'
    data: sData.map((d, i) => [sTime[i], d ? d.toFixed(2) : 0]),
  };
});

// Debug
//console.log('series');
//console.log(series);

const axisOptionX = {
  axisLabel: {
    // Should show all category values on the x-Axis but
    // does not work
    interval: 0,
    color: "rgba(128, 128, 128, .9)",
  },
  formatter: "{d}",
  axisLine: {
    show: false,
    onZero: false,
  },
  splitLine: {
    lineStyle: {
      color: "rgba(128, 128, 128, .2)",
    },
  },
  // Work around the 'interval: 0' issue
  // Potentially causes issues for low data count
  splitNumber: 31,
  boundaryGap: true,
  axisTick: {
    show: false,
    interval: 0,
    alignWithLabel: true,
  },
};

const axisOptionY = {
  axisLabel: {
    formatter: function (value) {
      // 'toLocaleString' applies internationalization to the
      // number format, e.g. thousands separator
      return value.toLocaleString() + " Wh";
    },
    color: "rgba(128, 128, 128, .9)",
  },
  axisTick: {
    show: false,
  },
  axisLine: {
    show: false,
  },
  splitLine: {
    lineStyle: {
      color: "rgba(128, 128, 128, .2)",
    },
  },
};

return {
  color: [
    "#27727b", // Series A
    "#c23531", // Series B
    "#9bca63", // Series C
  ],
  backgroundColor: "transparent",
  tooltip: {
    trigger: "axis",
    valueFormatter: function (value) {
      return (value / 1000.0).toFixed(2).toLocaleString() + " kWh";
    },
    axisPointer: {
      type: "shadow",
      label: {
        // For whatever reason axisPointer.label sets the tooltip "heading"
        formatter: function (params) {
          const tmpDate = new Date(params.value);
          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          return tmpDate.toLocaleDateString("en-EN", options);
        },
      },
    },
  },
  legend: {
    left: "0",
    bottom: "0",
    textStyle: {
      color: "rgba(128, 128, 128, .9)",
    },
  },
  xAxis: Object.assign(
    {
      type: "time",
    },
    axisOptionX
  ),
  yAxis: Object.assign(
    {
      type: "value",
    },
    axisOptionY
  ),
  grid: {
    left: 10,
    right: 10,
    top: 6,
    bottom: 24,
    containLabel: true,
  },
  series,
};
```

## Dashboard to Try

Following dashboard is a ready-to-go example that can be imported into Grafana as JSON. It requires the [Static data source](/plugins/volkovlabs-static-datasource/) and Apache ECharts visualization panel plugin.

Make sure to install Static data source via the `Administration -> Plugins` menu and then add it via the `Administration -> Data Sources` menu.

Once the Static data source is installed and added and the Apache ECharts visualization panel is installed, go to the `Dashboard` menu and select `Import`. In the **Import dashboard** window, insert the JSON code into the **Import via panel json** field (copy the JSON code from below).

<Image
  title="Import dashboard window."
  src="/img/blog/2022-10-04-stacked-bar-graph/import-dashboard.png"
/>

Specify the dashboard name and Static data source, click **Import**.

<Image
  title="Provide Name and datasource in the import menu window."
  src="/img/blog/2022-10-04-stacked-bar-graph/import-dashboard-step2.png"
/>

You should see the visualization working right away.

<Image
  title="Apache ECharts and data sources configuration."
  src="/img/blog/2022-10-04-stacked-bar-graph/dashboard.png"
/>

<details>
  <summary>Dashboard</summary>

```json reference
https://github.com/VolkovLabs/volkovlabs.io/blob/main/blog/2022-10-04-stacked-bar-graph/dashboard.json
```

</details>

Any feedback and comments are welcome. Feel free to challenge us with your questions. It helps us to stay sharp!
