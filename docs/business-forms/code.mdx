---
tags:
  - Business Forms
image: /img/plugins/business-forms/request.png
---

import Image from "@theme/Image";

# Custom Code

Custom code allows you to access the panel's options, REST API responses, form elements, and various Grafana services.

Custom code is executed after the `Initial` and `Update` requests, when `Element Value Changed`.

## Parameters

| Parameter                                              | Description                                                                                                                                   | <span style={{fontSize:'14px'}}>Initial, Update</span> | <span style={{fontSize:'14px'}}>Change Value</span> | <span style={{fontSize:'14px'}}>ShowIf, DisableIf, Get Options</span> |
| :----------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ | --------------------------------------------------- | --------------------------------------------------------------------- |
| `context.element`                                      | Current element                                                                                                                               |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.data`                                   | Result set of panel queries.                                                                                                                  | :heavy_check_mark:                                     | :heavy_check_mark:                                  | :heavy_check_mark: (For `Get Options`)                                |
| `context.panel.elements`                               | Form elements.                                                                                                                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  | :heavy_check_mark:                                                    |
| `context.panel.initial`                                | Parsed values from the initial request.                                                                                                       | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.initialRequest()`                       | Performs an initial request to reload the panel.                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onChange()`                             | Updates elements in the local state. Added in v3.1.0.                                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.options`                                | Panel's options.                                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onOptionsChange()`                      | Modifies a handler to refresh the panel.                                                                                                      | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onChangeElements([])`                   | Change elements. Accepts an array of new elements.                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.patchFormValue({})`                     | Update the value of the elements. Accepts an object.                                                                                          | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.setFormValue({})`                       | Update the value of the elements. Accepts an object. If value is not passed to the element, the value should be used from initial or cleared. | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.formValue()`                            | Contains a current form value as object.                                                                                                      | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.response`                               | Request's response.                                                                                                                           | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.panel.setInitial({})`                         | Specifies initial values for a custom initial request to highlight modified values and requests a user's confirmation.                        | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.panel.enableSubmit()`                         | Enable Submit button                                                                                                                          | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableSubmit()`                        | Disable Submit button                                                                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.enableReset()`                          | Enable Reset button                                                                                                                           |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableReset()`                         | Disable Reset button                                                                                                                          |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.enableSaveDefault()`                    | Enable Save Default button                                                                                                                    |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableSaveDefault()`                   | Disable Save Default button                                                                                                                   |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.setError('Message')`                    | Displays an error on panel.                                                                                                                   |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.collapseSection(id)`                    | Collapse Section. Added in v4.0.0.                                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.expandSection(id)`                      | Expand Section. Added in v4.0.0.                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.toggleSection(id)`                      | Toggle (Collapse/Expand) Section. Added in v4.0.0.                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsExpandedState`                  | Expand/Collapse State for Sections. Added in v4.0.0.                                                                                          | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.locationService`                      | Grafana's `locationService` function to work with the browser's location and history.                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.backendService`                       | Grafana's `backendService` used to communicate to a remote backend such as the Grafana backend, a datasource etc.                             | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.grafana.notifyError(['Header', 'Message'])`   | Displays an error.                                                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.notifySuccess(['Header', 'Message'])` | Displays a success notification.                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.notifyWarning(['Header', 'Message'])` | Displays a warning.                                                                                                                           | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.eventBus`                             | Publish and subscribe to application events.                                                                                                  | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.templateService`                      | Grafana's `templateService` function that provides access to variables and enables the update of a time range.                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.refresh()`                            | Function to refresh dashboard panels using application events.                                                                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.replaceVariables()`                   | Function to interpolate variables.                                                                                                            |                                                        |                                                     | :heavy_check_mark:                                                    |

To find out the current parameters, you can log them in the browser's console:

```javascript
console.log(
  context.panel.options,
  context.panel.data,
  context.panel.response,
  context.panel.elements,
  context.grafana.locationService,
  context.grafana.templateService
);
```

## Refresh Dashboard after update request or show warning

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.grafana.notifySuccess(["Update", "Values updated successfully."]);
  context.panel.initialRequest();
} else {
  context.grafana.notifyError([
    "Update",
    `An error occurred updating values: ${context.panel.response.status}`,
  ]);
}
```

## Update variable after update request to interact with other panels

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.panel.response.json().then((resp) => {
    context.grafana.locationService.partial({ "var-name": resp["name"] }, true);
  });
}
```

## Perform Initial Request after update request or show error

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.grafana.notifySuccess(["Update", "Values updated successfully."]);
  context.panel.initialRequest();
} else {
  context.grafana.notifyError([
    "Error",
    `An error occurred updating values: ${context.panel.response.status}`,
  ]);
}
```

## Perform initial request only on dashboard load

```javascript
const getValues = async () => {
  /**
   * Check if all values are empty
   */
  const isFirstLoad = context.panel.elements.every((element) => !element.value);

  if (isFirstLoad) {
    /**
     * Get Data
     */
    const response = await fetch();
    const json = await response.json();

    /**
     * Update initial element values
     */
    context.panel.onChange(
      context.panel.elements.map((element) => ({
        ...element,
        value: json[element.id],
      }))
    );
  }
};

return getValues();
```

## Clear elements' values after click on the Submit or Reset button

```javascript
context.panel.onOptionsChange({
  ...options,
  elements: options.elements.map((element) => {
    return element.id === "name" ? { ...element, value: "test" } : element;
  }),
});
```

:::info Refresh panel

The `context.panel.onOptionsChange()` handler calls refresh panel.

:::

The `context.panel.onOptionsChange()` handler is required to update the panel.

### Update local state in Data Manipulation panel 3.1.0

```javascript
context.panel.onChange(
  elements.map((element) => {
    return element.id === "name" ? { ...element, value: "test" } : element;
  })
);
```

The `context.panel.onChange()` function is required to update the element values in the local state.


### Simplified the Form Elements `patchFormValues` helper

Before version 4.4.0, in order to update a form element value, a user had to use `context.panel.elements.map()`. In the 4.4.0, we added a new function to simplify that approach. It has an object's key as an inpit parameter and a new value.

Before 4.4.0 version:

```javascript
context.panel.onChangeElements(
  context.panel.elements.map((element) =>
    element.id === "name" ? { ...element, value: "Alex" } : element
  )
);
```

The simplified version example:

```javascript
// only passed elements should be updated, the rest stay the same
context.panel.patchFormValues({ name: "Alex" });
// name and isAdmin
context.panel.patchFormValues({ name: "Alex", isAdmin: true });
```

### Simplified the Form Elements `formValue` helper

Before version 4.4.0, in order to get a form element value, a user had to use `context.panel.elements.forEach()`. In the 4.4.0, we added a new function to simplify that approach. It has an object's key as an inpit parameter.

Before 4.4.0 version:

```
const payload = {};

context.panel.elements.forEach((element) => {
  payload[element.id] = element.value;
});

// payload = { name: 'Alex', isAdmin: true }
```

The simplified version example:

```
context.panel.formValue // { name: 'Alex', isAdmin: true }
```