---
tags:
  - Business Forms
image: /img/plugins/business-forms/request.png
---

import Image from "@theme/Image";

# Custom Code

Custom code allows you to access the panel's options, REST API responses, form elements, and various Grafana services.

Custom code is executed after the `Initial` and `Update` requests, when `Element Value Changed`.

## Parameters

| Parameter                                                                                                            | Description                                                                                                                                   | <span style={{fontSize:'14px'}}>Initial, Update</span> | <span style={{fontSize:'14px'}}>Change Value</span> | <span style={{fontSize:'14px'}}>ShowIf, DisableIf, Get Options</span> |
| :------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------ | --------------------------------------------------- | --------------------------------------------------------------------- |
| `context.element`                                                                                                    | Current element                                                                                                                               |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.data`                                                                                                 | Result set of panel queries.                                                                                                                  | :heavy_check_mark:                                     | :heavy_check_mark:                                  | :heavy_check_mark: (For `Get Options`)                                |
| `context.panel.elements`                                                                                             | Form elements.                                                                                                                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  | :heavy_check_mark:                                                    |
| `context.panel.initial`                                                                                              | Parsed values from the initial request.                                                                                                       | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.initialRequest()`                                                                                     | Performs an initial request to reload the panel.                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onChange()`                                                                                           | Updates elements in the local state. Added in v3.1.0.                                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.options`                                                                                              | Panel's options.                                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onOptionsChange()`                                                                                    | Modifies a handler to refresh the panel.                                                                                                      | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.onChangeElements([])`                                                                                 | Change elements. Accepts an array of new elements.                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.patchFormValue({})`                                                                                   | Update the value of the elements. Accepts an object.                                                                                          | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.setFormValue({})`                                                                                     | Update the value of the elements. Accepts an object. If value is not passed to the element, the value should be used from initial or cleared. | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.formValue()`                                                                                          | Contains a current form value as object.                                                                                                      | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.response`                                                                                             | Request's response.                                                                                                                           | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.panel.setInitial({})`                                                                                       | Specifies initial values for a custom initial request to highlight modified values and requests a user's confirmation.                        | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.panel.enableSubmit()`                                                                                       | Enable Submit button                                                                                                                          | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableSubmit()`                                                                                      | Disable Submit button                                                                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.enableReset()`                                                                                        | Enable Reset button                                                                                                                           |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableReset()`                                                                                       | Disable Reset button                                                                                                                          |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.enableSaveDefault()`                                                                                  | Enable Save Default button                                                                                                                    |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.disableSaveDefault()`                                                                                 | Disable Save Default button                                                                                                                   |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.setError('Message')`                                                                                  | Displays an error on panel.                                                                                                                   |                                                        | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.add(section)`                                                                           | Add new Sections. Added in v4.9.0.                                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.update(sections)`                                                                       | Change Sections. Added in v4.9.0.                                                                                                             | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.remove(id)`                                                                             | Remove Section. Added in v4.9.0.                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.assign(id, elements)`                                                                   | Assign elements to Section. Added in v4.9.0.                                                                                                  | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.unassign(elements)`                                                                     | Unassign elements from Section. Added in v4.9.0.                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.get(id)`                                                                                | Get Section by id. Return Section with elements assign to section. Added in v4.9.0.                                                           | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.panel.sectionsUtils.getAll()`                                                                               | Get All Sections. Return Sections with elements assign to each section. Added in v4.9.0.                                                      | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| <sub>v4.9.0: `context.panel.sectionsUtils.collapse(id)` <br /> v4.0.0: `context.panel.collapseSection(id)`</sub>     | Collapse Section. Added in v4.0.0. Updated in v4.9.0.                                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| <sub>v4.9.0: `context.panel.sectionsUtils.expand(id)` <br /> v4.0.0: `context.panel.expandSection(id)` </sub>        | Expand Section. Added in v4.0.0. Updated in v4.9.0.                                                                                           | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| <sub>v4.9.0: `context.panel.sectionsUtils.toggle(id)` <br /> v4.0.0: `context.panel.toggleSection(id)` </sub>        | Toggle (Collapse/Expand) Section. Added in v4.0.0. Updated in v4.9.0.                                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| <sub>v4.9.0: `context.panel.sectionsUtils.expandedState` <br /> v4.0.0: `context.panel.sectionsExpandedState` </sub> | Expand/Collapse State for Sections. Added in v4.0.0. Updated in v4.9.0.                                                                       | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.locationService`                                                                                    | Grafana's `locationService` function to work with the browser's location and history.                                                         | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.backendService`                                                                                     | Grafana's `backendService` used to communicate to a remote backend such as the Grafana backend, a datasource etc.                             | :heavy_check_mark:                                     |                                                     |                                                                       |
| `context.grafana.notifyError(['Header', 'Message'])`                                                                 | Displays an error.                                                                                                                            | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.notifySuccess(['Header', 'Message'])`                                                               | Displays a success notification.                                                                                                              | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.notifyWarning(['Header', 'Message'])`                                                               | Displays a warning.                                                                                                                           | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.eventBus`                                                                                           | Publish and subscribe to application events.                                                                                                  | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.templateService`                                                                                    | Grafana's `templateService` function that provides access to variables and enables the update of a time range.                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.refresh()`                                                                                          | Function to refresh dashboard panels using application events.                                                                                | :heavy_check_mark:                                     | :heavy_check_mark:                                  |                                                                       |
| `context.grafana.replaceVariables()`                                                                                 | Function to interpolate variables.                                                                                                            |                                                        |                                                     | :heavy_check_mark:                                                    |

To find out the current parameters, you can log them in the browser's console:

```javascript
console.log(
  context.panel.options,
  context.panel.data,
  context.panel.response,
  context.panel.elements,
  context.grafana.locationService,
  context.grafana.templateService
);
```

## Parameters usage

### sectionsUtils

### sectionsUtils.add(section)

_Added in: v4.9.0_

:::info Refresh panel

The `context.panel.sectionsUtils.add(section)` handler calls the refresh panel.

If you use it in the initial request, don't forget to disable the Synchronize option.
Enabling the Synchronize option and using it together with `context.panel.sectionsUtils.add(section)` in the Initial Request will cause the panel to reload constantly.

:::

**Usage**

```javascript
context.panel.sectionsUtils.add(section);
```

**Example**

```javascript
context.panel.sectionsUtils.add({
  name: "Section 1",
  id: "id-s-1",
  elements: [],
});

const newSection = {
  name: "Section 2",
  id: "id-s-2",
  elements: ["elem-1", "elem-2"],
};

context.panel.sectionsUtils.add(newSection);
```

**Arguments**

- `section` _Object_
  <br />
  Section. Each section include `name`, `id`, `elements`

Common Section properties.

- `name` _string_. Section name.

- `id` _string_. Section Id.

- `elements` _Array_. Elements ids assign to section. Could Be empty array.

### sectionsUtils.update(sections)

_Added in: v4.9.0_

:::info Refresh panel

The `context.panel.sectionsUtils.update(sections)` handler calls the refresh panel.

If you use it in the initial request, don't forget to disable the Synchronize option.
Enabling the Synchronize option and using it together with `context.panel.sectionsUtils.update(sections)` in the Initial Request will cause the panel to reload constantly.

:::

**Usage**

```javascript
context.panel.sectionsUtils.update(sections);
```

**Example**

```javascript
context.panel.sectionsUtils.update([{ name: "Section 1", id: "id-s-1" }]);
```

**Arguments**

- `sections` _Array_
  <br />
  Sections. Each section include `name` and `id`

### sectionsUtils.remove(id)

_Added in: v4.9.0_

:::info Refresh panel

The `context.panel.sectionsUtils.remove(id)` handler calls the refresh panel.

If you use it in the initial request, don't forget to disable the Synchronize option.
Enabling the Synchronize option and using it together with `context.panel.sectionsUtils.remove(id)` in the Initial Request will cause the panel to reload constantly.

:::

**Usage**

```javascript
context.panel.removeSection(id);
```

**Example**

```javascript
context.panel.removeSection("id-s-1");
```

**Arguments**

- `id` _string_. Section id.

### sectionsUtils.assign(id,elements)

_Added in: v4.9.0_

:::info Refresh panel

The `context.panel.sectionsUtils.assign(id,elements)` handler calls the refresh panel.

If you use it in the initial request, don't forget to disable the Synchronize option.
Enabling the Synchronize option and using it together with `context.panel.sectionsUtils.assign(id,elements)` in the Initial Request will cause the panel to reload constantly.

:::

**Usage**

```javascript
context.panel.sectionsUtils.assign(id, elements);
```

**Example**

```javascript
context.panel.sectionsUtils.assign("id-s-1", ["elem-1", "elem-2"]);
```

**Arguments**

- `id` _string_. Section Id.
- `elements` _Array_. Array of elements ids

### sectionsUtils.unassign(elements)

_Added in: v4.9.0_

:::info Refresh panel

The `context.panel.sectionsUtils.unassign(elements)` handler calls the refresh panel.

If you use it in the initial request, don't forget to disable the Synchronize option.
Enabling the Synchronize option and using it together with `context.panel.sectionsUtils.unassign(elements)` in the Initial Request will cause the panel to reload constantly.

:::

**Usage**

```javascript
context.panel.sectionsUtils.unassign(elements);
```

**Example**

```javascript
context.panel.sectionsUtils.unassign(["elem-1", "elem-2"]);
```

**Arguments**

- `elements` _Array_. Array of elements ids

### sectionsUtils.get(id)

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.get(id);
```

**Example**

```javascript
context.panel.sectionsUtils.get("section-id");
```

**Arguments**

- `id` _string_. Section Id

### sectionsUtils.getAll()

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.getAll();
```

**Example**

```javascript
context.panel.sectionsUtils.getAll();
```

### sectionsUtils.collapse(id)

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.collapse(id);
```

**Example**

```javascript
context.panel.sectionsUtils.collapse("section-id");
```

**Arguments**

- `id` _string_. Section Id

### sectionsUtils.expand(id)

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.expand(id);
```

**Example**

```javascript
context.panel.sectionsUtils.expand("section-id");
```

**Arguments**

- `id` _string_. Section Id

### sectionsUtils.toggle(id)

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.toggle(id);
```

**Example**

```javascript
context.panel.sectionsUtils.toggle("section-id");
```

**Arguments**

- `id` _string_. Section Id

### sectionsUtils.expandedState

_Added in: v4.9.0_

**Usage**

```javascript
context.panel.sectionsUtils.expandedState;
```

**Example**

```javascript
const sectionsExpandedState = context.panel.sectionsUtils.expandedState;
```

## Refresh Dashboard after update request or show warning

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.grafana.notifySuccess(["Update", "Values updated successfully."]);
  context.grafana.refresh();
} else {
  context.grafana.notifyError([
    "Update",
    `An error occurred updating values: ${context.panel.response.status}`,
  ]);
}
```

## Update variable after update request to interact with other panels

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.panel.response.json().then((resp) => {
    context.grafana.locationService.partial({ "var-name": resp["name"] }, true);
  });
}
```

## Perform Initial Request after update request or show error

```javascript
if (context.panel.response && context.panel.response.ok) {
  context.grafana.notifySuccess(["Update", "Values updated successfully."]);
  context.panel.initialRequest();
} else {
  context.grafana.notifyError([
    "Error",
    `An error occurred updating values: ${context.panel.response.status}`,
  ]);
}
```

## Perform initial request only on dashboard load

```javascript
const getValues = async () => {
  /**
   * Check if all values are empty
   */
  const isFirstLoad = context.panel.elements.every((element) => !element.value);

  if (isFirstLoad) {
    /**
     * Get Data
     */
    const response = await fetch();
    const json = await response.json();

    /**
     * Update initial element values
     */
    context.panel.onChange(
      context.panel.elements.map((element) => ({
        ...element,
        value: json[element.id],
      }))
    );
  }
};

return getValues();
```

## Clear elements' values after click on the Submit or Reset button

```javascript
context.panel.onOptionsChange({
  ...context.panel.options,
  elements: context.panel.options.elements.map((element) => {
    return element.id === "name" ? { ...element, value: "test" } : element;
  }),
});
```

:::info Refresh panel

The `context.panel.onOptionsChange()` handler calls refresh panel.

:::

The `context.panel.onOptionsChange()` handler is required to update the panel.

## Update local state in Data Manipulation panel 3.1.0

```javascript
context.panel.onChange(
  elements.map((element) => {
    return element.id === "name" ? { ...element, value: "test" } : element;
  })
);
```

The `context.panel.onChange()` function is required to update the element values in the local state.

## Simplified the Form Elements `patchFormValue` helper

Before version 4.4.0, in order to update a form element value, a user had to use `context.panel.elements.map()`. In the 4.4.0, we added a new function to simplify that approach. It has an object's key as an inpit parameter and a new value.

Before 4.4.0 version:

```javascript
context.panel.onChangeElements(
  context.panel.elements.map((element) =>
    element.id === "name" ? { ...element, value: "Alex" } : element
  )
);
```

The simplified version example:

```javascript
// only passed elements should be updated, the rest stay the same
context.panel.patchFormValue({ name: "Alex" });
// name and isAdmin
context.panel.patchFormValue({ name: "Alex", isAdmin: true });
```

## Simplified the Form Elements `formValue` helper

Before version 4.4.0, in order to get a form element value, a user had to use `context.panel.elements.forEach()`. In the 4.4.0, we added a new function to simplify that approach. It has an object's key as an inpit parameter.

Before 4.4.0 version:

```
const payload = {};

context.panel.elements.forEach((element) => {
  payload[element.id] = element.value;
});

// payload = { name: 'Alex', isAdmin: true }
```

The simplified version example:

```
context.panel.formValue // { name: 'Alex', isAdmin: true }
```
